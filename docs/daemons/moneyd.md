# moneyd - 货币系统守护进程

## 功能概述

moneyd守护进程负责游戏货币系统的核心功能，包括货币格式化显示、支付处理和玩家财产计算。支持黄金、白银、铜钱三种货币类型以及银票大额货币。

## 货币体系

### 货币单位换算
- **1两黄金** = 100两白银 = 10,000文铜钱
- **1两白银** = 100文铜钱
- **1张银票** = 10,000文铜钱（100两白银）

### 货币对象定义
- `CASH_OB` - 银票对象（大额货币）
- `GOLD_OB` - 黄金对象
- `SILVER_OB` - 白银对象
- `COIN_OB` - 铜钱对象

## 接口函数

### money_str
```lpc
string money_str(int amount)
```
将数值金额转换为中文货币描述字符串。

**参数：**
- `amount`: 金额数值（以文铜钱为单位）

**返回值：**
- 中文货币描述，如"三两黄金二两白银五文铜钱"

**示例：**
```lpc
money_str(30205)  // 返回 "三两黄金二两白银五文铜钱"
```

### price_str
```lpc
string price_str(int amount)
```
将数值金额转换为带"又"字连接的中文价格描述。

**特点：**
- 使用"又"字连接不同货币单位
- 金额小于1时自动设为1
- 格式更适合价格显示

**示例：**
```lpc
price_str(30205)  // 返回 "三两黄金又二两白银又五文铜板"
```

### pay_player
```lpc
void pay_player(object who, int amount)
```
向玩家支付指定金额的货币，自动按最优方式分配货币类型。

**支付规则：**
- 金额≥100万且≥10银票单位时，优先发放银票
- 剩余金额按黄金、白银、铜钱顺序发放
- 金额小于1时自动设为1

**参数：**
- `who`: 玩家对象
- `amount`: 支付金额（以文铜钱为单位）

### player_pay
```lpc
int player_pay(object who, int amount)
```
从玩家处收取指定金额的货币，支持自动货币兑换。

**返回值：**
- `1`: 支付成功
- `0`: 余额不足
- `2`: 需要银票但余额不足

**货币使用优先级：**
1. 银票（金额≥10万或玩家处于scheme状态）
2. 黄金
3. 白银
4. 铜钱

**自动兑换逻辑：**
- 优先使用大额货币，自动找零
- 支持银票、黄金、白银、铜钱之间的自动转换
- 精确计算各种货币的最优组合

### player_carry
```lpc
int player_carry(object ob)
```
计算玩家携带的货币总价值，以黄金为单位。

**计算方式：**
- 银行存款：余额/10000（转换为黄金单位）
- 银票：数量×10（每张银票=10两黄金）
- 黄金：直接计数
- 白银：数量/100（100两白银=1两黄金）
- 铜钱：数量/10000（10000文铜钱=1两黄金）

**返回值：**
- 玩家携带货币的总黄金价值

## 工作流程

### 货币支付流程
1. **金额验证**：确保金额有效（≥1）
2. **银票判断**：大额支付优先使用银票
3. **货币分配**：按银票→黄金→白银→铜钱顺序创建对应对象
4. **对象移动**：将货币对象移动到玩家身上

### 货币收取流程
1. **余额查询**：统计玩家各种货币数量
2. **总额计算**：计算玩家总财富价值
3. **余额检查**：判断玩家余额是否足够支付
4. **货币兑换**：按优先级使用货币，自动找零
5. **数量更新**：更新玩家身上各种货币对象的数量

## 使用示例

```lpc
// 支付货币给玩家
pay_player(player, 123456);  // 支付12银票3黄金4白银56铜钱

// 从玩家收取货币
if (player_pay(player, 50000)) {
    tell_object(player, "支付成功！");
} else {
    tell_object(player, "余额不足！");
}

// 计算玩家财富
total_gold = player_carry(player);
printf("玩家携带财富：%d两黄金\n", total_gold);

// 格式化显示金额
string money_desc = money_str(87654);
string price_desc = price_str(87654);
```

## 技术特点

- **智能货币分配**：自动按最优方式分配各种货币类型
- **灵活的支付系统**：支持大额支付和小额交易
- **自动找零机制**：精确的货币兑换和找零计算
- **安全性检查**：完善的余额验证和错误处理
- **高效性能**：优化的货币计算和对象管理
# logind - 登录守护进程

## 📋 概述

logind 是炎黄群侠传MUD游戏的登录认证守护进程，负责处理玩家连接、身份验证、角色创建和断线重连。基于实际代码实现，提供完整的用户登录管理功能。

## 🎯 主要功能

### 1. 连接管理
- **新连接处理** - 接收和处理新的玩家连接请求
- **IP安全检查** - 检查IP封禁状态
- **连接数控制** - 管理单IP最大连接数（当前已禁用）
- **连接状态跟踪** - 维护连接会话信息

### 2. 身份验证系统
- **双密码系统** - 支持管理密码和普通密码
- **角色存在检查** - 验证玩家角色是否存在
- **密码强度验证** - 管理密码≥5位，普通密码≥3位
- **重复登录处理** - 强制断开旧连接

### 3. 角色创建系统
- **角色命名** - 中文姓名2-8字，禁止敏感词汇
- **性别选择** - 男性/女性选择
- **ID生成** - 3-8位小写字母，系统保留ID检查
- **初始属性** - 随机生成基础属性（10-30范围）

### 4. 断线重连
- **会话恢复** - 处理玩家断线后的重新连接
- **状态保持** - 恢复玩家断线前的游戏状态

## 💻 技术实现

### 核心数据结构

```lpc
// 禁止使用的姓名
string *banned_name = ({"你","我","他","神","仙","佛","狗","猪","爸","妈",...});

// 禁止使用的ID
string *banned_id = ({"admin","all","api","arch","auth","backup","bbs","bin",...});

// 连接超时时间
#define LOGIN_TIMEOUT 300
```

### 主要函数接口

#### 连接建立
```lpc
void logon(object ob)
```
- 处理新玩家连接，显示欢迎信息，开始登录流程

#### 角色创建
```lpc
object make_body(object ob)
```
- 创建新的玩家角色对象，初始化基础属性

#### 进入游戏
```lpc
varargs void enter_world(object ob, object user, int silent)
```
- 将玩家正式引入游戏世界

#### 重连处理
```lpc
varargs void reconnect(object ob, object user, int silent)
```
- 处理玩家断线重连

## 🔄 工作流程

### 新连接处理流程
1. **IP检查** → 检查IP封禁状态
2. **欢迎显示** → 显示欢迎信息和在线人数
3. **ID获取** → 获取并验证玩家ID
4. **角色检查** → 检查角色是否存在
5. **分支处理** → 存在则验证密码，不存在则创建角色

### 角色创建流程
1. **姓名设置** → 中文姓名验证（2-8字）
2. **性别选择** → 男性/女性选择
3. **密码设置** → 双密码系统设置
4. **属性初始化** → 随机生成基础属性

### 身份验证流程
1. **密码验证** → 验证管理密码/普通密码
2. **重复登录** → 强制断开旧连接
3. **进入游戏** → 加载玩家数据进入游戏世界

## ⚙️ 配置参数

### 系统限制
- **ID长度**: 3-8个小写字母
- **姓名长度**: 2-8个汉字
- **管理密码**: ≥5个字符
- **普通密码**: ≥3个字符
- **连接超时**: 300秒

### 安全检查
- **IP封禁**: 支持IP地址封禁检查
- **ID黑名单**: 禁止使用系统保留ID
- **姓名黑名单**: 禁止使用不当姓名
- **重复登录**: 强制断开重复连接

## ⚠️ 开发注意事项

### 数据安全
1. **密码加密** - 使用crypt()函数加密存储
2. **输入验证** - 严格验证所有用户输入
3. **会话管理** - 正确处理会话建立和销毁
4. **并发控制** - 防止重复登录冲突

### 性能优化
1. **连接超时** - 设置合理的连接超时时间
2. **资源清理** - 及时清理断开的连接对象
3. **错误处理** - 提供友好的错误提示信息

### 扩展性考虑
1. **模块化设计** - 功能模块独立可维护
2. **配置化参数** - 系统参数应可配置
3. **国际化支持** - 考虑多语言支持

## 🔧 开发接口

### 连接配置
```lpc
// 典型配置参数
#define LOGIN_TIMEOUT  300    // 登录超时时间
#define MIN_ID_LEN     3      // 最小ID长度
#define MAX_ID_LEN     8      // 最大ID长度
#define MIN_NAME_LEN   2      // 最小姓名长度
#define MAX_NAME_LEN   8      // 最大姓名长度
```

### 错误处理
```lpc
// 连接错误处理
void logon(object ob)
{
    // 检查IP封禁
    if (BAN_D->is_banned(query_ip_number(ob)))
    {
        write("您的IP地址已被封禁，请联系管理员。\n");
        destruct(ob);
        return;
    }

    // 检查连接数限制
    if (sizeof(users()) >= MAX_USERS)
    {
        write("对不起，游戏人数已满，请稍后再试。\n");
        destruct(ob);
        return;
    }
}
```

### 角色创建示例
```lpc
// 初始化玩家属性
me->set("age", 14);
me->set("str", 10 + random(21));
me->set("con", 10 + random(21));
me->set("dex", 10 + random(21));
me->set("int", 10 + random(21));
me->set("per", 10 + random(21));
```

## 📋 登录流程命令

### 标准登录命令
```bash
# 系统会自动引导完成登录流程
连接游戏 -\u003e 输入ID -\u003e 输入密码 -\u003e 进入游戏
# 或
连接游戏 -\u003e 输入ID -\u003e 创建新角色 -\u003e 设置姓名 -\u003e 设置性别 -\u003e 设置密码 -\u003e 进入游戏
```

### 相关功能
- **断线重连**: 自动处理网络断线重连
- **双密码系统**: 管理密码和普通密码
- **角色保护**: 防止重复登录冲突

---
*基于 adm/daemons/logind.c 实际代码实现*
*维护团队：炎黄群侠传开发组*
# npcd - NPC系统守护进程

## 功能概述

npcd守护进程负责管理游戏中的NPC系统，包括NPC创建、技能等级初始化、位置管理、随机移动、挑战者生成等功能。支持多种国籍的NPC生成和智能化的NPC行为管理。

## 核心数据结构

### 城市位置映射表
```lpc
mapping place = ([
    "洛阳城":({"/d/luoyang/xidoor", "/d/luoyang/beidoor", ...}),
    "北京城":({"/d/beijing/tiananmen", "/d/beijing/dianmen", ...}),
    "长安城":({"/d/changan/dong-chengmen", "/d/changan/nan-chengmen", ...}),
    // ... 共30+个地区
]);
```

### 经验值-技能等级映射表
```lpc
mapping levels = ([
    50000:20,     // level 1  - 5万经验
    100000:30,    // level 2  - 10万经验
    200000:40,    // level 3  - 20万经验
    // ... level 1-26
    120000000:1000, // level 26 - 1.2亿经验
]);
```

### 国籍支持
```lpc
string *nations = ("中国", "日本", "龟慈", "荷兰", "天竺", "蒙古",
                   "俄罗斯", "英吉利", "法兰西", "西班牙", "葡萄牙",
                   "比利时", "塔吉克斯坦", "哈沙克斯坦", "乌兹别克斯坦");
```

## 接口函数

### 等级检测函数

#### check_level
```lpc
int check_level(object ob)
```
根据角色的战斗经验返回对应的等级（1-26级）。

**算法：**
- 遍历经验值映射表，找到第一个大于角色经验值的门槛
- 返回对应的等级序号

#### get_exp
```lpc
int get_exp(object ob)
```
获取角色的战斗经验值。

### NPC技能初始化

#### init_npc_skill
```lpc
void init_npc_skill(object ob, int lvl)
```
初始化NPC的技能等级和属性。

**功能：**
- 根据等级设置战斗经验值
- 计算技能等级（支持自定义公式）
- 设置魔法点数
- 设置特殊标志（breakup, animaout）
- 统一设置所有技能等级

**技能等级计算公式：**
- 经验 < 60万：`(exp * 10)^(1/3) * 0.6 + 10`
- 经验 < 200万：`(exp * 10)^(1/3) * (0.6 + exp/10000000)`
- 经验 ≥ 200万：`(exp * 10)^(1/3) * 0.8`

**特殊标志：**
- `breakup`：技能等级≥300时设置
- `animaout`：技能等级≥500时设置

### NPC创建函数

#### create_npc
```lpc
object create_npc(string nation, int lvl)
```
创建指定国籍和等级的NPC。

**支持国籍：**
- **中国**：使用中文名字生成
- **日本**：使用日文名字生成
- **英吉利**：使用英文名字生成
- **欧洲国籍**（法兰西、西班牙、葡萄牙、比利时、荷兰）：使用欧洲名字生成
- **天竺**：使用印度名字生成
- **其他**：返回0（未实现）

**流程：**
1. 根据国籍创建对应的NPC对象
2. 生成相应的名字
3. 设置国籍属性
4. 初始化技能等级

#### create_challenger
```lpc
object create_challenger()
```
创建挑战者NPC，等级基于在线玩家的最高等级。

**算法：**
1. 统计所有在线非巫师玩家的最高等级
2. 等级 = 最高等级 + 1
3. 如果计算等级 < 3，则使用最高等级
4. 从预设国籍中随机选择（偏重日本和其他国家）
5. 创建对应等级的NPC

### NPC属性复制

#### set_from_me
```lpc
void set_from_me(object tob, object fob, int scale)
```
将源对象的属性按比例复制到目标对象。

**复制的属性：**
- 四项基本属性（str, con, dex, int）
- 容貌（per）
- 生命、内力、经验值
- 内力加成（jiali）

**转世加成：**
- 转世次数影响基础属性（每项+2）
- 比例缩放影响生命、内力等数值属性

### 位置管理函数

#### random_place
```lpc
string random_place(string *not_place)
```
随机选择一个地区，可排除指定地区。

#### place_npc
```lpc
void place_npc(object ob, string *not_place, string *in_place)
```
将NPC放置在随机位置。

**功能：**
- 从指定地区或所有地区中选择
- 排除不需要的地区
- 在选定地区中随机选择具体房间
- 设置NPC的位置相关属性
- 显示移动消息

**设置的属性：**
- `place`：所在地区名称
- `startroom`：起始房间路径
- `temp/moved`：移动历史记录

### 随机移动函数

#### random_move
```lpc
void random_move(object ob)
```
控制NPC的随机移动行为。

**算法：**
1. 获取移动历史记录
2. 如果移动次数≥5次，强制返回上一个位置
3. 否则随机选择有效出口
4. 避开战斗区域（no_fight）
5. 更新移动历史
6. 执行移动命令

**智能特性：**
- 避免在狭小空间内来回移动
- 优先选择非战斗区域
- 记录移动轨迹，防止无限循环

### 绝顶高手查询

#### query_ultra_master
```lpc
object *query_ultra_master()
```
返回游戏中的绝顶高手对象数组。

**包含的高手：**
- 黄裳（HUANG_SHANG）
- 独孤求败（DUGU_QIUBAI）
- 葵花太监（KUIHUA_TAIJIAN）
- 火山（HUO_SHAN）

## 工作流程

### NPC创建流程
1. **国籍选择** - 确定NPC的国籍类型
2. **对象创建** - 实例化对应国籍的NPC类
3. **名字生成** - 根据国籍生成合适的名字
4. **技能初始化** - 设置等级对应的技能和经验
5. **属性设置** - 设置国籍等基本属性

### 挑战者生成流程
1. **等级评估** - 分析在线玩家的等级分布
2. **难度计算** - 确定挑战者的等级（略高于最高等级玩家）
3. **国籍选择** - 从预设国籍中随机选择
4. **NPC创建** - 生成对应等级和国籍的挑战者

### NPC位置管理流程
1. **地区选择** - 从可用地区中随机选择
2. **房间选择** - 在选定地区中随机选择具体房间
3. **属性设置** - 设置NPC的位置属性
4. **移动显示** - 显示NPC到达的消息

### 随机移动流程
1. **历史检查** - 查看移动历史记录
2. **路径选择** - 智能选择移动方向
3. **移动执行** - 执行移动命令
4. **历史更新** - 更新移动轨迹记录

## 使用示例

```lpc
// 创建中国籍5级NPC
object npc = npcd->create_npc("中国", 5);

// 创建挑战者（自动计算等级）
object challenger = npcd->create_challenger();

// 放置NPC到随机位置
npcd->place_npc(npc, ({"北京城", "长安城"}));

// 让NPC随机移动
npcd->random_move(npc);

// 获取玩家等级
int level = npcd->check_level(player);

// 获取绝顶高手列表
object *masters = npcd->query_ultra_master();
```

## 技术特点

- **多国籍支持** - 支持15种不同国籍的NPC生成
- **智能等级系统** - 26个等级，支持经验值到技能等级的精确映射
- **动态挑战者** - 根据在线玩家实力动态生成挑战者
- **智能移动算法** - 避免循环移动，优先选择合适路径
- **灵活的位置管理** - 支持30+个主要城市和地区
- **属性复制系统** - 支持按比例复制角色属性
- **转世系统兼容** - 支持转世角色的属性加成

## 支持的地区

### 主要城市
北京城、洛阳城、长安城、开封城、中州城、苏州城、杭州城、襄阳城、扬州城、昆明城、荆州城、兰州城、成都城、福州城、灵州城

### 特殊地区
泉州城、华山附近、凌霄城附近、五毒教附近、佛山一带、南海一带、汝州一带、嵩山一带、终南山、星宿海、天山、关外、西域、大理一带、武功镇

## 等级体系

NPC系统支持26个等级，从5万经验值到12亿经验值，对应技能等级从20级到1000级。新增的高等级（17-26级）为转世玩家提供挑战，确保游戏后期的可玩性。每个等级都有对应的经验值门槛和技能等级标准。','file_path':'C:\Users\oiuv\home\mud\docs\daemons\npcd.md'}